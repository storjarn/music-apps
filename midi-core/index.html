<script src="../bower/ee-class/dist/Class.min.js"></script>
<script src="../bower/ee-class/dist/Namespace.min.js"></script>
<script src="../bower/ee-class/dist/EventEmitter.min.js"></script>
<script src="../bower/d3/d3.min.js"></script>
<script src="./lib/MIDI.js"></script>
<script src="./lib/Constants.js"></script>
<script src="./lib/Clock.js"></script>
<script src="./lib/Track.js"></script>
<script src="../music-ui/lib/Grid.js"></script>
<script>
    window.addEventListener('load', function() {
        MIDI.initialize(function() {
            var ddMidiInputs = document.getElementById("midiInputs");
            for ( var i = 0; i < MIDI.inputs.length; ++i) {
                // input.value.onmidimessage = MIDIMessageEventHandler;
                haveAtLeastOneDevice = true;
                var option = document.createElement("option");
                option.value = MIDI.inputs[i].id;
                option.text = MIDI.inputs[i].name;
                ddMidiInputs.appendChild(option);
            }
        });

        var mockInput = {
            onmidimessage: function(ev) {
                // console.log("Input", ev);
            }
        };
        var mockOutput = {
            send: function(msg) {
                // console.log("Output", msg);
            }
        };

        var clock = window.clock = new MIDI.Clock();
        var now = new Date().getTime();
        clock.on('clock', function(clockMessage, clock){
            if (clock.State.tickCount % 24 === 0){
                console.log('Beat,', new Date().getTime() - now, 'ms long');
                now = new Date().getTime();
                document.getElementById('pulseIndicator').setAttribute('class', 'on');
            }
            if (clock.State.tickCount % 26 === 0){
                document.getElementById('pulseIndicator').setAttribute('class', 'off');
            }
            document.getElementById('tempo').value = clock.State.tempo;
            tempo = parseFloat(document.getElementById('tempoSelect').value);

            // tempos.push(clock.State.tempo);

            document.getElementById('tempoAverage').value = (function() {
                // var ret = 0;
                // for(var i = 0; i < tempos.length; ++i) {
                //     ret += tempos[i];
                // }
                // return ret / tempos.length;
                var ret =(clock.State.tickCount / clock.State.ppq) / ((new Date().getTime() - clock.State.startTime) / 60000);
                return ret;
            })();
        });
        clock.linkOutput(mockOutput);
        clock.linkInput(mockInput);

        var tempo = 30;
        var tmr = null;
        var tempos = [];

        window.go = function () {
            tmr = setTimeout(function() {
                function generate() {
                    return Math.round(Math.random() * 256);
                }
                var msg = {data: [MIDI.Constants.TimingClock, 0, 0]};
                mockInput.onmidimessage(msg);
                // msg = {data: [generate(), generate(), generate()]};
                // mockInput.onmidimessage(msg);
                clearTimeout(tmr);
                go();
            }, MIDI.Utility.tempoToPulseInterval(tempo));
        };


    });
</script>

<div id="app">
    <div>MIDI Inputs</div>
    <select id="midiInputs"></select>
    <div>
        Desired Tempo: <input id="tempoSelect" value="60" style="width: 60px" onchange="go()" /> BPM
    </div>
    <div>
        Actual Tempo: <input id="tempo" disabled value="0" style="width: 60px" /> BPM
        <svg width="10" height="10">
            <circle id="pulseIndicator" class="off" r="5" cx="5" cy="5"></circle>
        </svg>
    </div>
    <div>
        Average Tempo: <input id="tempoAverage" disabled value="0" style="width: 60px" /> BPM
    </div>
    <div id="pianoRoll">
    </div>
</div>

<style>
circle.off {
    color: transparent;
    fill: transparent;
}
circle.on {
    color: green;
    fill: green;
}
svg {
    font: 10px sans-serif;
}
.grid .tick {
    stroke: lightgrey;
    opacity: 0.7;
}
.grid path {
    stroke-width: 0;
}
.axis {
    shape-rendering: crispEdges;
}
.axis line {
    fill: none;
    shape-rendering: crispEdges;
}
.y.axis line, .y.axis path {
    fill: none;
    stroke: lightgrey;
}
</style>
